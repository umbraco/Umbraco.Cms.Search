name: $(TeamProject)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

parameters:
  - name: cache_nuget
    displayName: Cache NuGet packages
    type: boolean
    default: false

variables:
  solution: src/Umbraco.Cms.Search.sln
  buildConfiguration: Release
  DOTNET_NOLOGO: true
  DOTNET_GENERATE_ASPNET_CERTIFICATE: false
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  npm_config_cache: $(Pipeline.Workspace)/.npm_client

stages:
  - stage: Build
    variables:
      NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
    jobs:
      - job: Build
        pool:
          vmImage: "ubuntu-latest"
        steps:
          # Checkout source (avoid shallow clone to calculate version height)
          - checkout: self
            fetchDepth: 0

          # Setup build environment
          - task: NuGetAuthenticate@1
            displayName: Authenticate NuGet

          - task: UseDotNet@2
            displayName: Use .NET SDK from global.json
            inputs:
              useGlobalJson: true

          # Client
          - task: NodeTool@0
            displayName: Use Node.js
            retryCountOnTaskFailure: 3
            inputs:
              versionSource: 'fromFile'
              versionFilePath: src/Umbraco.Cms.Search.Core.Client/Client/.nvmrc

          - bash: |
              echo "##[command]Install nbgv"
              dotnet tool install --tool-path . nbgv
              echo "##[command]Running nbgv get-version"
              PACKAGE_VERSION=$(nbgv get-version -v NpmPackageVersion)
              echo "##[command]Running npm version"
              echo "##[debug]Version: $PACKAGE_VERSION"
              cd src/Umbraco.Cms.Search.Core.Client/Client
              npm version $PACKAGE_VERSION --allow-same-version --no-git-tag-version
            displayName: Set NPM Version

          - task: Cache@2
            displayName: Cache node_modules
            inputs:
              key: '"npm_client" | "$(Agent.OS)"| $(Build.SourcesDirectory)/src/Umbraco.Cms.Search.Core.Client/Client/package-lock.json'
              restoreKeys: |
                "npm_client" | "$(Agent.OS)"
                "npm_client"
              path: $(npm_config_cache)

          - script: npm ci --no-fund --no-audit --prefer-offline
            displayName: Install NPM packages
            workingDirectory: src/Umbraco.Cms.Search.Core.Client/Client

          - script: npm run lint:errors-only
            displayName: Lint Client (errors only)
            workingDirectory: src/Umbraco.Cms.Search.Core.Client/Client

          - script: npm run build
            displayName: Build Client
            workingDirectory: src/Umbraco.Cms.Search.Core.Client/Client

          # Cache and restore NuGet packages
          - task: Cache@2
            condition: ${{ parameters.cache_nuget }}
            displayName: Cache NuGet packages
            inputs:
              key: 'nuget | "$(Agent.OS)" | **/packages.lock.json, !**/bin/**, !**/obj/**'
              restoreKeys: |
                nuget | "$(Agent.OS)"
                nuget
              path: $(NUGET_PACKAGES)

          - script: dotnet restore $(solution) --locked-mode
            displayName: Restore NuGet packages

          # Build
          - script: dotnet build $(solution) --configuration $(buildConfiguration) --no-restore -p:ContinuousIntegrationBuild=true
            displayName: Run dotnet build

          # Pack
          - script: dotnet pack $(solution) --configuration $(buildConfiguration) --no-restore --output $(Build.ArtifactStagingDirectory)/nupkg
            displayName: Run dotnet pack

          # Publish
          - task: PublishPipelineArtifact@1
            displayName: Publish NuGet packages
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)/nupkg
              artifactName: nupkg

          - task: PublishPipelineArtifact@1
            displayName: Publish build output
            inputs:
              targetPath: $(Build.SourcesDirectory)
              artifactName: build_output

  - stage: UnitTests
    displayName: Unit Tests
    dependsOn: Build
    jobs:
      - job: UnitTests
        displayName: Run Unit Tests
        pool:
          vmImage: 'windows-latest'
        steps:
          # Checkout source
          - checkout: self

          # Setup test environment
          - task: DownloadPipelineArtifact@2
            displayName: Download build artifacts
            inputs:
              artifact: build_output
              path: $(Build.SourcesDirectory)

          - task: UseDotNet@2
            displayName: Use .NET SDK from global.json
            inputs:
              useGlobalJson: true

          # Test
          - task: DotNetCoreCLI@2
            displayName: Run dotnet test
            inputs:
              command: test
              projects: "src/Umbraco.Test.Search.Unit/Umbraco.Test.Search.Unit.csproj"
              arguments: "--configuration $(buildConfiguration) --no-build"
              testRunTitle: Unit Tests - $(Agent.OS)

  - stage: IntegrationTests
    displayName: Integration Tests
    dependsOn: Build
    jobs:

      # Integration Tests (SQLite)
      - job: IntegrationTestsSQLite
        displayName: Run Integration Tests (SQLite)
        pool:
          vmImage: 'windows-latest'
        timeoutInMinutes: 60
        steps:
          - checkout: self
            submodules: false
            lfs: false,
            fetchDepth: 1
            fetchFilter: tree:0

          # Setup test environment
          - task: DownloadPipelineArtifact@2
            displayName: Download build artifacts
            inputs:
              artifact: build_output
              path: $(Build.SourcesDirectory)

          - task: UseDotNet@2
            displayName: Use .NET SDK from global.json
            inputs:
              useGlobalJson: true

          # Test
          - task: DotNetCoreCLI@2
            displayName: Run Examine tests
            inputs:
              command: test
              projects: "src/Umbraco.Test.Search.Examine.Integration/Umbraco.Test.Search.Examine.Integration.csproj"
              arguments: '--configuration $(buildConfiguration) --no-build'
              testRunTitle: Examine Integration Tests SQLite - $(Agent.OS)
          - task: DotNetCoreCLI@2
            displayName: Run Core tests
            inputs:
              command: test
              projects: "src/Umbraco.Test.Search.Integration/Umbraco.Test.Search.Integration.csproj"
              arguments: '--configuration $(buildConfiguration) --no-build'
              testRunTitle: Integration Tests SQLite - $(Agent.OS)

      # Integration Tests (SQL Server)
      - job: IntegrationTestsSQLServer
        displayName: Run Integration Tests (SQL Server)
        pool:
          vmImage: 'windows-latest'
        timeoutInMinutes: 60
        steps:
          # Setup test environment
          - task: DownloadPipelineArtifact@2
            displayName: Download build artifacts
            inputs:
              artifact: build_output
              path: $(Build.SourcesDirectory)

          - task: UseDotNet@2
            displayName: Use .NET SDK from global.json
            inputs:
              useGlobalJson: true

          # Start SQL Server
          - powershell: docker run --name mssql -d -p 1433:1433 -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=$(SA_PASSWORD)" mcr.microsoft.com/mssql/server:2022-latest
            displayName: Start SQL Server Docker image (Linux)
            condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

          - powershell: |
              $maxAttempts = 12
              $attempt = 0
              $status = ""

              while (($status -ne 'running') -and ($attempt -lt $maxAttempts)) {
                Start-Sleep -Seconds 5
                # We use the docker inspect command to check the status of the container. If the container is not running, we wait 5 seconds and try again. And if reaches 12 attempts, we fail the build.
                $status = docker inspect -f '{{.State.Status}}' mssql

                if ($status -ne 'running') {
                  Write-Host "Waiting for SQL Server to be ready... Attempt $($attempt + 1)"
                  $attempt++
                }
              }

              if ($status -eq 'running') {
                Write-Host "SQL Server container is running"
                docker ps -a
              } else {
                Write-Host "SQL Server did not become ready in time. Last known status: $status"
                docker logs mssql
                exit 1
              }
            displayName: Wait for SQL Server to be ready (Linux)
            condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

          - pwsh: SqlLocalDB start MSSQLLocalDB
            displayName: Start SQL Server LocalDB (Windows)
            condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

          # Test
          - task: DotNetCoreCLI@2
            displayName: Run Examine tests
            inputs:
              command: test
              projects: "src/Umbraco.Test.Search.Examine.Integration/Umbraco.Test.Search.Examine.Integration.csproj"
              arguments: '--configuration $(buildConfiguration) --no-build'
              testRunTitle: Examine Integration Tests SQL Server - $(Agent.OS)
          - task: DotNetCoreCLI@2
            displayName: Run Core tests
            inputs:
              command: test
              projects: "src/Umbraco.Test.Search.Integration/Umbraco.Test.Search.Integration.csproj"
              arguments: '--configuration $(buildConfiguration) --no-build'
              testRunTitle: Integration Tests SQL Server - $(Agent.OS)

          # Stop SQL Server
          - pwsh: docker stop mssql
            displayName: Stop SQL Server Docker image (Linux)
            condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

          - pwsh: SqlLocalDB stop MSSQLLocalDB
            displayName: Stop SQL Server LocalDB (Windows)
            condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))

  - stage: E2E 
    displayName: E2E Tests
    dependsOn: Build
    variables:
      npm_config_cache_e2e: $(Pipeline.Workspace)/.npm_e2e
      # Umbraco unattended install settings
      UMBRACO__CMS__UNATTENDED__INSTALLUNATTENDED: true
      UMBRACO__CMS__UNATTENDED__UNATTENDEDUSERNAME: Playwright Test
      UMBRACO__CMS__UNATTENDED__UNATTENDEDUSERPASSWORD: "1234567890"
      UMBRACO__CMS__UNATTENDED__UNATTENDEDUSEREMAIL: admin@localhost.local
      # Umbraco settings
      UMBRACO__CMS__GLOBAL__INSTALLMISSINGDATABASE: true
      UMBRACO__CMS__GLOBAL__USEHTTPS: true
      UMBRACO__CMS__GLOBAL__DISABLEELECTIONFORSINGLESERVER: true
      UMBRACO__CMS__GLOBAL__VERSIONCHECKPERIOD: 0
      UMBRACO__CMS__CONTENT__CONTENTVERSIONCLEANUPPOLICY__ENABLECLEANUP: false
      UMBRACO__CMS__HEALTHCHECKS__NOTIFICATION__ENABLED: false
      UMBRACO__CMS__KEEPALIVE__DISABLEKEEPALIVETASK: true
      # SQLite connection string
      CONNECTIONSTRINGS__UMBRACODBDSN: "Data Source=|DataDirectory|/Umbraco.sqlite.db;Cache=Shared;Foreign Keys=True;Pooling=True"
      CONNECTIONSTRINGS__UMBRACODBDSN_PROVIDERNAME: Microsoft.Data.Sqlite
      # Note: uSync settings are configured in appsettings.Development.json
      # which uses "../_uSync/Shared/" path - we copy _uSync as sibling of testsite
    jobs:
      - job:
        displayName: E2E Tests (SQLite)
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 30
        variables:
          testSiteUrl: 'https://localhost:44324'
        steps:
          # Checkout source (full clone for Nerdbank.GitVersioning)
          - checkout: self
            fetchDepth: 0

          # Setup environment
          - task: DownloadPipelineArtifact@2
            displayName: Download build artifacts
            inputs:
              artifact: build_output
              path: $(Build.SourcesDirectory)

          - task: UseDotNet@2
            displayName: Use .NET SDK from global.json
            inputs:
              useGlobalJson: true

          - task: NodeTool@0
            displayName: Use Node.js
            inputs:
              versionSpec: '22.x'

          - pwsh: |
              "UMBRACO_USER_LOGIN=$(UMBRACO__CMS__UNATTENDED__UNATTENDEDUSEREMAIL)
              UMBRACO_USER_PASSWORD=$(UMBRACO__CMS__UNATTENDED__UNATTENDEDUSERPASSWORD)
              URL=$(testSiteUrl)" | Out-File .env
            displayName: Generate .env
            workingDirectory: src/Umbraco.Test.Search.AcceptanceTest

          # Cache npm packages
          - script: mkdir -p $(npm_config_cache_e2e)
            displayName: Create npm cache directory

          - task: Cache@2
            displayName: Cache npm packages
            inputs:
              key: '"npm_e2e" | "$(Agent.OS)" | src/Umbraco.Test.Search.AcceptanceTest/package-lock.json'
              restoreKeys: |
                "npm_e2e" | "$(Agent.OS)"
                "npm_e2e"
              path: $(npm_config_cache_e2e)

          # Install acceptance test dependencies
          - script: npm ci --no-fund --no-audit --prefer-offline
            displayName: Install acceptance test NPM packages
            workingDirectory: src/Umbraco.Test.Search.AcceptanceTest

          - script: npx playwright install --with-deps chromium
            displayName: Install Playwright browsers
            workingDirectory: src/Umbraco.Test.Search.AcceptanceTest

          # Generate HTTPS dev certificate
          - script: dotnet dev-certs https --trust
            displayName: Generate HTTPS dev certificate
            continueOnError: true

          # Publish and run the test site
          - script: dotnet publish src/Umbraco.Web.TestSite.V17/Umbraco.Web.TestSite.V17.csproj --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/testsite
            displayName: Publish test site

          # Copy _uSync as sibling of testsite to match Development config path "../_uSync/Shared/"
          - script: |
              echo "=== Copying uSync data ==="
              cp -r $(Build.SourcesDirectory)/src/_uSync $(Build.ArtifactStagingDirectory)/
              echo "=== Verifying folder structure ==="
              ls -la $(Build.ArtifactStagingDirectory)/
              echo "=== uSync folder contents ==="
              find $(Build.ArtifactStagingDirectory)/_uSync -type f | head -20
            displayName: Copy uSync data

          - script: |
              cd $(Build.ArtifactStagingDirectory)/testsite
              echo "=== Environment ==="
              echo "ASPNETCORE_ENVIRONMENT=$ASPNETCORE_ENVIRONMENT"
              echo "Working directory: $(pwd)"
              echo "=== Verifying uSync path ==="
              ls -la ../_uSync/Shared/ || echo "uSync folder not found at ../_uSync/Shared/"
              echo "=== Starting test site ==="
              nohup dotnet Umbraco.Web.TestSite.V17.dll --urls="$(testSiteUrl)" > testsite.log 2>&1 &
              echo $! > testsite.pid
              echo "Test site started with PID $(cat testsite.pid)"
            displayName: Start test site
            env:
              ASPNETCORE_ENVIRONMENT: Development
              ASPNETCORE_URLS: $(testSiteUrl)
              UMBRACO__CMS__UNATTENDED__INSTALLUNATTENDED: $(UMBRACO__CMS__UNATTENDED__INSTALLUNATTENDED)
              UMBRACO__CMS__UNATTENDED__UNATTENDEDUSERNAME: $(UMBRACO__CMS__UNATTENDED__UNATTENDEDUSERNAME)
              UMBRACO__CMS__UNATTENDED__UNATTENDEDUSERPASSWORD: $(UMBRACO__CMS__UNATTENDED__UNATTENDEDUSERPASSWORD)
              UMBRACO__CMS__UNATTENDED__UNATTENDEDUSEREMAIL: $(UMBRACO__CMS__UNATTENDED__UNATTENDEDUSEREMAIL)
              UMBRACO__CMS__GLOBAL__INSTALLMISSINGDATABASE: $(UMBRACO__CMS__GLOBAL__INSTALLMISSINGDATABASE)
              UMBRACO__CMS__GLOBAL__USEHTTPS: $(UMBRACO__CMS__GLOBAL__USEHTTPS)
              UMBRACO__CMS__GLOBAL__DISABLEELECTIONFORSINGLESERVER: $(UMBRACO__CMS__GLOBAL__DISABLEELECTIONFORSINGLESERVER)
              UMBRACO__CMS__GLOBAL__VERSIONCHECKPERIOD: $(UMBRACO__CMS__GLOBAL__VERSIONCHECKPERIOD)
              UMBRACO__CMS__CONTENT__CONTENTVERSIONCLEANUPPOLICY__ENABLECLEANUP: $(UMBRACO__CMS__CONTENT__CONTENTVERSIONCLEANUPPOLICY__ENABLECLEANUP)
              UMBRACO__CMS__HEALTHCHECKS__NOTIFICATION__ENABLED: $(UMBRACO__CMS__HEALTHCHECKS__NOTIFICATION__ENABLED)
              UMBRACO__CMS__KEEPALIVE__DISABLEKEEPALIVETASK: $(UMBRACO__CMS__KEEPALIVE__DISABLEKEEPALIVETASK)
              CONNECTIONSTRINGS__UMBRACODBDSN: $(CONNECTIONSTRINGS__UMBRACODBDSN)
              CONNECTIONSTRINGS__UMBRACODBDSN_PROVIDERNAME: $(CONNECTIONSTRINGS__UMBRACODBDSN_PROVIDERNAME)

          - script: |
              echo "Waiting for test site to be ready..."
              for i in {1..60}; do
                if curl -k -s -o /dev/null -w "%{http_code}" $(testSiteUrl) | grep -q "200\|301\|302"; then
                  echo "Test site is ready!"
                  echo "=== Last 50 lines of testsite.log ==="
                  tail -50 $(Build.ArtifactStagingDirectory)/testsite/testsite.log || true
                  echo "=== Checking for uSync messages ==="
                  grep -i "usync" $(Build.ArtifactStagingDirectory)/testsite/testsite.log || echo "No uSync messages found"
                  exit 0
                fi
                echo "Attempt $i: Test site not ready yet, waiting..."
                sleep 5
              done
              echo "Test site failed to start"
              echo "=== Full testsite.log ==="
              cat $(Build.ArtifactStagingDirectory)/testsite/testsite.log
              exit 1
            displayName: Wait for test site to be ready

          # Run acceptance tests
          - script: npm run test
            displayName: Run Playwright tests
            workingDirectory: src/Umbraco.Test.Search.AcceptanceTest
            env:
              CI: true

          # Publish test results
          - task: PublishTestResults@2
            displayName: Publish test results
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'src/Umbraco.Test.Search.AcceptanceTest/results/results.xml'
              testRunTitle: 'Acceptance Test Results'
              failTaskOnFailedTests: true

          - task: PublishPipelineArtifact@1
            displayName: Publish test artifacts
            condition: succeededOrFailed()
            inputs:
              targetPath: src/Umbraco.Test.Search.AcceptanceTest/results
              artifactName: acceptance-test-results

          # Stop test site
          - script: |
              if [ -f $(Build.ArtifactStagingDirectory)/testsite/testsite.pid ]; then
                kill $(cat $(Build.ArtifactStagingDirectory)/testsite/testsite.pid) || true
              fi
            displayName: Stop test site
            condition: always()

  - stage: Dependency_Track
    displayName: Dependency Track
    dependsOn:
      - Build
      - IntegrationTests
    # Only upload the SBOM when it's from the main branch, as we don't need to for every PR.
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: sbom
        displayName: Upload SBOM to DependencyTrack
        steps:
          - checkout: self
            fetchDepth: 0

          - task: PowerShell@2
            displayName: 'Read Version from version.json'
            inputs:
              targetType: 'inline'
              script: |
                $versionJson = Get-Content -Path "version.json" -Raw | ConvertFrom-Json
                $version = $versionJson.version
                Write-Host "Version from version.json: $version"
                Write-Host "##vso[task.setvariable variable=VersionNumber]$version"

          - script: dotnet tool install --global CycloneDX
            displayName: 'Install CycloneDX .NET Tool'

          - script: dotnet CycloneDX $(solution)
            displayName: 'Generate NuGet SBOM'

          # This is step optional. Allows download of artifact from pipeline run view in ADO.
          - publish: bom.xml
            artifact: sbom
            displayName: 'Publish NuGet SBOM Artifact'

          - task: upload-bom-dtrack@1
            displayName: 'Upload SBOM to Dependency-Track'
            inputs:
              bomFilePath: bom.xml
              dtrackProjName: $(Build.Repository.Name)
              dtrackProjVersion: $(VersionNumber)
              dtrackAPIKey: $(DT_API_KEY)
              dtrackURI: $(DT_API_URL)
              dtrackProjAutoCreate: true

